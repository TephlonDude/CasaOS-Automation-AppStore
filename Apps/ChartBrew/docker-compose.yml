

x-casaos:
  title: "ChartBrew"
  description: "Open-source charts & dashboards. Connect to DBs/APIs and build real-time visualizations."
  icon: "https://selfh.st/icons/ChartBrew.svg"
  category: "Analytics & Dashboards"
  architectures: [amd64, arm64]
  author: "Jason McFeetors"
  developer: "ChartBrew"
  homepage: "https://chartbrew.com"
  main: "chartbrew"
  port_map: "4018"
  fallback_images:
    - "${CHARTBREW_FALLBACK_IMAGE:-chartbrew/chartbrew:latest}"
  tips:
    - "Backup Data: Regularly back up \/DATA/AppData/chartbrew\ to protect your configuration and data"
    - "Logs: Monitor application logs via the CasaOS app management UI to troubleshoot issues"
    - "Performance: Allocate sufficient resources (CPU/memory) through CasaOS settings for optimal performance"
    - "Integration: Explore integrations with other CasaOS apps to enhance functionality"
    - "Updates: Check for updates regularly through the CasaOS AppStore to get bug fixes and new features"

services:
  chartbrew:
    # Pin the image to a stable ChartBrew release for predictable updates
    image: chartbrew/chartbrew:v4.6.0
    container_name: chartbrew
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # ── App ────────────────────────────────────────────────────────────────────
      - NODE_ENV=production
      - PORT=4018
      # ── MySQL ─────────────────────────────────────────────────────────────────
      - CB_DB_TYPE=mysql
      - CB_DB_HOST=mysql
      - CB_DB_PORT=3306
      - CB_DB_NAME=chartbrew
      - CB_DB_USER=chartbrew
      - CB_DB_PASS=${CB_DB_PASS:-REPLACE_WITH_SECURE_PASSWORD}
      # ── Redis (caching/queues) ────────────────────────────────────────────────
      - REDIS_URL=redis://:${REDIS_PASSWORD:-REPLACE_WITH_SECURE_PASSWORD}@redis:6379/0
      # ── Session/crypto ────────────────────────────────────────────────────────
      - CB_SECRET=${CB_SECRET:-REPLACE_WITH_SECURE_PASSWORD}
    ports:
      - "4018:4018"
    volumes:
      # Persist app files, uploads, and SQLite database if used
      - /DATA/AppData/chartbrew:/app
    networks:
      - chartbrew-net
    healthcheck:
      # Use a shell which attempts wget then curl to improve portability in images
      test: ["CMD-SHELL", "wget -qO - http://127.0.0.1:4018/health || curl -fsS http://127.0.0.1:4018/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 25s

  mysql:
    image: mysql:8.0
    container_name: chartbrew-mysql
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:-REPLACE_WITH_SECURE_PASSWORD}
      - MYSQL_DATABASE=chartbrew
      - MYSQL_USER=chartbrew
      - MYSQL_PASSWORD=${CB_DB_PASS:-REPLACE_WITH_SECURE_PASSWORD}
    volumes:
      - /DATA/AppData/chartbrew/mysql:/var/lib/mysql
    networks:
      - chartbrew-net
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -u$$MYSQL_USER -p$$MYSQL_PASSWORD --silent"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: chartbrew-redis
    restart: unless-stopped
    command: >
      sh -c "exec redis-server --appendonly yes --requirepass $$REDIS_PASSWORD"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-REPLACE_WITH_SECURE_PASSWORD}
    volumes:
      - /DATA/AppData/chartbrew/redis:/data
    networks:
      - chartbrew-net
    healthcheck:
      # Use the runtime env value inside the container (`$$REDIS_PASSWORD`) so the
      # healthcheck runs with the same password the service uses at runtime.
      test: ["CMD-SHELL", "redis-cli -a '$$REDIS_PASSWORD' ping || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 10
      start_period: 15s

networks:
  chartbrew-net:
    driver: bridge
